<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNAPSHOT</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="pics/logo.png">
    <link rel="stylesheet" href="designs/result.css">

    <!-- QR ì½”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js"; // Firebase Storage ì¶”ê°€

        const firebaseConfig = {
          apiKey: "API_KEY",
          authDomain: "snapshot-4ad8f.firebaseapp.com",
          projectId: "snapshot-4ad8f",
          storageBucket: "snapshot-4ad8f.appspot.com",
          messagingSenderId: "1004891389072",
          appId: "1:1004891389072:web:35514d2ddafce071a42c15",
          measurementId: "G-1CZJZJRGG3"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app); // Storage ì´ˆê¸°í™”

        const currentUserId = localStorage.getItem('studentId');  // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°

        // ì‚¬ìš©ì ì •ë³´ì™€ ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì„œ í™”ë©´ì— ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜
        async function loadRanking() {
            const scoresRef = collection(db, "users");
            const q = query(scoresRef, orderBy("highestScore", "asc"));
            const querySnapshot = await getDocs(q);

            let rankingList = '';
            let rank = 1;
            let userRank = null;
            let userHighestScore = null;
            let userCupImage = null;  // ì‚¬ìš©ì ë³‘ëšœê»‘ ì´ë¯¸ì§€

            // N/A ê°’ì„ ê°€ì§„ ì‚¬ìš©ìë¥¼ ë§ˆì§€ë§‰ì— ë°°ì¹˜í•˜ê¸° ìœ„í•œ ë°°ì—´
            let normalRanking = [];
            let naRanking = [];

            querySnapshot.forEach((doc) => {
                const { name, department, studentId, highestScore, selectedCap } = doc.data();
                const score = highestScore ? highestScore.toFixed(3) : "N/A";

                if (studentId === currentUserId) {
                    userRank = rank;
                    userHighestScore = score;
                    userCupImage = selectedCap;  // ë³‘ëšœê»‘ ì´ë¯¸ì§€ ê²½ë¡œ ì €ì¥
                }

                // N/A ê°’ì„ ê°€ì§„ ì‚¬ìš©ìëŠ” ë”°ë¡œ ì €ì¥
                if (score === "N/A") {
                    naRanking.push({
                        rank: "N/A",
                        department,
                        studentId,
                        name,
                        score
                    });
                } else {
                    normalRanking.push({
                        rank,
                        department,
                        studentId,
                        name,
                        score
                    });
                    rank++;  // ì •ìƒì ì¸ ì ìˆ˜ì¼ ë•Œë§Œ ìˆœìœ„ ì¦ê°€
                }
            });

            // ì •ìƒì ì¸ ìˆœìœ„ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
            normalRanking.forEach(item => {
                rankingList += `<tr>
                                <td>${item.rank}</td>
                                <td>${item.department}</td>
                                <td>${item.studentId}</td>
                                <td>${item.name}</td>
                                <td>${item.score} CM</td>
                                </tr>`;
            });

            // N/A ìˆœìœ„ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ (ë§ˆì§€ë§‰ì— ë°°ì¹˜)
            naRanking.forEach(item => {
                rankingList += `<tr>
                                <td>-</td>
                                <td>${item.department}</td>
                                <td>${item.studentId}</td>
                                <td>${item.name}</td>
                                <td>${item.score}</td>
                                </tr>`;
            });

            // ì‚¬ìš©ì ìµœê³  ê¸°ë¡ ë° ë“±ìˆ˜ í‘œì‹œ
            if (userHighestScore !== null && userRank !== null) {
                document.getElementById('your-score').textContent = `${userHighestScore} CM`;
                document.getElementById('your-rank').innerHTML = `${userRank}<sup>st</sup>`;
            } else {
                document.getElementById('your-score').textContent = "N/A";
                document.getElementById('your-rank').innerHTML = "N/A";
            }

            document.getElementById('ranking-list').innerHTML = rankingList;

            // ë³‘ëšœê»‘ ì´ë¯¸ì§€ ë° ê²°ê³¼ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
            if (userCupImage) {
                drawResultImage(userCupImage, userHighestScore, userRank, new Date().toLocaleString());
            } else {
                console.error("ë³‘ëšœê»‘ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
            }
        }


        // ìº”ë²„ìŠ¤ì— ê²°ê³¼ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
        function drawResultImage(cupImageSrc, score, rank, dateTime) {
            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const img = new Image();
            img.src = cupImageSrc;  // ë³‘ëšœê»‘ ì´ë¯¸ì§€ ê²½ë¡œ
            img.onload = () => {
                // ë³‘ëšœê»‘ ì´ë¯¸ì§€ í¬ê¸° 200x200ìœ¼ë¡œ ì„¤ì •í•˜ê³  ì¤‘ì•™ì— ë°°ì¹˜
                const imgWidth = 200;
                const imgHeight = 200;
                const margin = 70;  // ë³‘ëšœê»‘ê³¼ ê¸€ì ì‚¬ì´ì˜ margin
                const startY = 50;  // ë³‘ëšœê»‘ ì‹œì‘ ìœ„ì¹˜

                ctx.drawImage(img, (canvas.width - imgWidth) / 2, startY, imgWidth, imgHeight);  // ë³‘ëšœê»‘ ì´ë¯¸ì§€ë¥¼ ì¤‘ì•™ì— ë§ì¶¤

                // í…ìŠ¤íŠ¸ í¬ê¸° ë° ìœ„ì¹˜ ì¡°ì •
                ctx.font = '28px Noto Sans KR';  // "ë‹¹ì‹ ì˜ ìµœê³  ê¸°ë¡" ê¸€ìì˜ í¬ê¸° 28pxë¡œ ì„¤ì •
                ctx.textAlign = 'center';
                ctx.fillStyle = '#000';

                // "ë‹¹ì‹ ì˜ ìµœê³  ê¸°ë¡" í…ìŠ¤íŠ¸
                ctx.fillText('ë‹¹ì‹ ì˜ ìµœê³  ê¸°ë¡', canvas.width / 2, 280);  // ë³‘ëšœê»‘ ì´ë¯¸ì§€ ì•„ë˜ë¡œ ìœ„ì¹˜ ì¡°ì •

                ctx.font = 'bold 48px Noto Sans KR';  // ìµœê³  ê¸°ë¡ ìˆ«ìì˜ í¬ê¸° 48pxë¡œ ì„¤ì •
                ctx.fillText(`${score} CM`, canvas.width / 2, 340);  // í…ìŠ¤íŠ¸ ìœ„ì¹˜ ì¡°ì •

                ctx.font = '28px Noto Sans KR';  // "ë‹¹ì‹ ì˜ ë“±ìˆ˜" ê¸€ìì˜ í¬ê¸° 28pxë¡œ ì„¤ì •
                ctx.fillText('ë‹¹ì‹ ì˜ ë“±ìˆ˜', canvas.width / 2, 410);

                ctx.font = 'bold 48px Noto Sans KR';  // ë“±ìˆ˜ ê¸€ìì˜ í¬ê¸° 48pxë¡œ ì„¤ì •
                ctx.fillText(`${rank}st`, canvas.width / 2, 470);

                ctx.font = 'italic 18px Noto Sans KR';  // ë‚ ì§œì˜ í¬ê¸° 18pxë¡œ ì„¤ì •
                ctx.fillText(`(${dateTime} ê¸°ì¤€)`, canvas.width / 2, 520);

                const logoImg = new Image();
                logoImg.src = 'pics/logo.png';  // ë¡œê³  ì´ë¯¸ì§€ ê²½ë¡œ
                logoImg.onload = () => {
                    // ë¡œê³  í¬ê¸° ì¡°ì • ë° ì¤‘ì•™ ë§ì¶¤ (60x60 í¬ê¸°ë¡œ ì„¤ì •)
                    ctx.drawImage(logoImg, (canvas.width - 60) / 2, 550, 60, 60);  // ë¡œê³  ì´ë¯¸ì§€ ìœ„ì¹˜ ì¡°ì •

                    // ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„ QRì½”ë“œ ìƒì„±
                    uploadResultToFirebase(canvas);
                };
            };
        }

        // Firebaseì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
        function uploadResultToFirebase(canvas) {
            const dataUrl = canvas.toDataURL('image/png');
            const storageRef = ref(storage, `results/${currentUserId}.png`);
            uploadString(storageRef, dataUrl, 'data_url').then((snapshot) => {
                console.log('Uploaded a data_url string!');
                getDownloadURL(snapshot.ref).then((downloadURL) => {
                    generateQRCode(downloadURL);  // ì´ë¯¸ì§€ URLë¡œ QR ì½”ë“œ ìƒì„±
                });
            }).catch((error) => {
                console.error('Error uploading image:', error);
            });
        }

        // QR ì½”ë“œ ìƒì„±
        function generateQRCode(imageUrl) {
            const qrCodeDiv = document.getElementById('qrcode');
            new QRCode(qrCodeDiv, {
                text: imageUrl,  // Firebase Storageì˜ ë‹¤ìš´ë¡œë“œ URL
                width: 96,
                height: 96
            });
        }

        window.onload = () => {
            loadRanking();  // ë­í‚¹ ë° ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        };

        // ë’¤ë¡œ ê°€ê¸° ì´ë²¤íŠ¸ ê°ì§€ -> í˜„ì¬ í˜ì´ì§€ë¡œ ì´ë™
        window.onpopstate = function() { 
            console.alert("ì´ í˜ì´ì§€ì—ì„œëŠ” ë’¤ë¡œê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            history.go(1); 
        };
    </script>
</head>
<body>
    <div class="container">
        <div class="left">
            <img src="pics/logo.png" alt="SnapShot Logo" class="logo">
            <h2 id="your-record-name">ë‹¹ì‹ ì˜ ìµœê³ ê¸°ë¡</h2>
            <h1 id="your-score">0.000 CM</h1>
            <h2 id="your-rank-name">ë‹¹ì‹ ì˜ ë“±ìˆ˜</h2>
            <h1 id="your-rank">0<sup>st</sup></h1>
            <div id="qrcode" class="qr-code"></div> <!-- QR ì½”ë“œê°€ ìƒì„±ë˜ëŠ” ë¶€ë¶„ -->
            <button class="home-btn" onclick="window.location.href='index.html'">í™ˆìœ¼ë¡œ</button>
        </div>

        <div class="right">
            <h2 id="ranking">ğŸ‘‘ë­í‚¹ğŸ‘‘</h2>
            <div class="ranking-container">
                <table class="ranking-table" border="1" cellspacing="0" cellpadding="5">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>í•™ê³¼</th>
                            <th>í•™ë²ˆ</th>
                            <th>ì´ë¦„</th>
                            <th>ê¸°ë¡</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-list">
                        <!-- Firebaseì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ì—¬ê¸°ì— í‘œì‹œ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <canvas id="resultCanvas" width="500" height="700" style="display:none;"></canvas> <!-- ê²°ê³¼ ìº”ë²„ìŠ¤ ìˆ¨ê¹€ -->
</body>
</html>
