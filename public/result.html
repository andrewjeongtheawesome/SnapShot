<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapShot Result</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="pics/logo.png">
    <link rel="stylesheet" href="result.css">

    <script type="module">
        // Firebase SDK ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
        
        // Firebase ì„¤ì •
        const firebaseConfig = {
          apiKey: "API_KEY",  // ì—¬ê¸°ì— ì‹¤ì œ API í‚¤ ì…ë ¥
          authDomain: "snapshot-4ad8f.firebaseapp.com",
          projectId: "snapshot-4ad8f",
          storageBucket: "snapshot-4ad8f.appspot.com",
          messagingSenderId: "1004891389072",
          appId: "1:1004891389072:web:35514d2ddafce071a42c15",
          measurementId: "G-1CZJZJRGG3"
        };
      
        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // í˜„ì¬ ì‚¬ìš©ìì˜ ID ê°€ì ¸ì˜¤ê¸° (ë¡œì»¬ ì €ì¥ì†Œë‚˜ ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹)
        const currentUserId = localStorage.getItem('studentId');  // ì‚¬ìš©ì í•™ë²ˆìœ¼ë¡œ ê³ ìœ  ì‹ë³„

        // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ì™€ ì „ì²´ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
        async function loadRanking() {
            const scoresRef = collection(db, "users");  // 'users' ì»¬ë ‰ì…˜ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜´
            const q = query(scoresRef, orderBy("highestScore", "asc"));  // ìµœê³  ê¸°ë¡ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
            const querySnapshot = await getDocs(q);

            let rankingList = '';
            let rank = 1;  // ìˆœìœ„ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬
            let userRank = null;  // í˜„ì¬ ì‚¬ìš©ì ë“±ìˆ˜ë¥¼ ì €ì¥í•  ë³€ìˆ˜
            let userHighestScore = null;  // í˜„ì¬ ì‚¬ìš©ì ìµœê³  ê¸°ë¡

            querySnapshot.forEach((doc) => {
                const { name, department, studentId, highestScore } = doc.data();
                const score = highestScore ? highestScore.toFixed(3) : "N/A";  // ì ìˆ˜ ì—†ëŠ” ê²½ìš° "N/A"ë¡œ í‘œì‹œ

                // í˜„ì¬ ì‚¬ìš©ìì¼ ê²½ìš° ë“±ìˆ˜ì™€ ìµœê³  ê¸°ë¡ ì €ì¥
                if (studentId === currentUserId) {
                    userRank = rank;
                    userHighestScore = score;
                }

                rankingList += `<tr>
                                  <td>${rank}</td>
                                  <td>${department}</td>
                                  <td>${studentId}</td>
                                  <td>${name}</td>
                                  <td>${score} CM</td>
                                </tr>`;
                rank++;  // ìˆœìœ„ ì¦ê°€
            });

            // ì‚¬ìš©ì ìµœê³  ê¸°ë¡ ë° ë“±ìˆ˜ í‘œì‹œ
            if (userHighestScore !== null && userRank !== null) {
                document.getElementById('your-score').textContent = `${userHighestScore} CM`;
                document.getElementById('your-rank').innerHTML = `${userRank}<sup>st</sup>`;
            } else {
                document.getElementById('your-score').textContent = "N/A";
                document.getElementById('your-rank').innerHTML = "N/A";
            }

            document.getElementById('ranking-list').innerHTML = rankingList;
        }

        // ë’¤ë¡œ ê°€ê¸° ë°©ì§€ ì„¤ì •
        window.onpopstate = function(event) {
            history.go(1);
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë­í‚¹ ë¡œë“œ
        window.onload = loadRanking;
    </script>
</head>
<body>
    <div class="container">
        <div class="left">
            <img src="pics/logo.png" alt="SnapShot Logo" class="logo">
            <h2 id="your-record-name">ë‹¹ì‹ ì˜ ìµœê³ ê¸°ë¡</h2>
            <h1 id="your-score">0.000 CM</h1>
            <h2 id="your-rank-name">ë‹¹ì‹ ì˜ ë“±ìˆ˜</h2>
            <h1 id="your-rank">0<sup>st</sup></h1>
            <button class="home-btn" onclick="window.location.href='index.html'">í™ˆìœ¼ë¡œ</button>
        </div>

        <div class="right">
            <h2 id="ranking">ğŸ‘‘ë­í‚¹ğŸ‘‘</h2>
            <!-- ë­í‚¹ í…Œì´ë¸”: ë†’ì´ë¥¼ ê³ ì •í•˜ê³  ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½ -->
            <div class="ranking-container">
                <table class="ranking-table" border="1" cellspacing="0" cellpadding="5">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>í•™ê³¼</th>
                            <th>í•™ë²ˆ</th>
                            <th>ì´ë¦„</th>
                            <th>ê¸°ë¡</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-list">
                        <!-- Firebaseì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ì—¬ê¸°ì— í‘œì‹œ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>
